// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPERADMIN
  COORDINATOR
}

model AllowedEmail {
  id        String   @id @default(cuid())
  email     String   @unique
  role      Role     @default(COORDINATOR)
  createdAt DateTime @default(now())
}

model User {
  id                      String             @id @default(cuid())
  email                   String             @unique
  name                    String?
  image                   String?
  role                    Role               @default(COORDINATOR)
  passwordHash            String?
  passwordSetupAt         DateTime?
  failedLoginCount        Int                @default(0)
  lockedUntil             DateTime?
  lastLoginAt             DateTime?
  currentChallenge        String?
  currentChallengeExpires DateTime?
  mfaRequired             Boolean            @default(true)
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  events                  Event[]
  createdInvites          AdminInvite[]      @relation("InviteCreator")
  acceptedInvites         AdminInvite[]      @relation("InviteAcceptor")
  passkeys                PasskeyCredential[]
  auditLogs               AdminAuditLog[]

  @@map("users")
}

model Event {
  id             String   @id @default(cuid())
  title          String
  slug           String   @unique
  date           DateTime
  location       String
  description    String   @db.Text
  highlightImage String?
  mediaUrls      String?  @db.Text
  published      Boolean  @default(false)
  showOnCalendar Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  authorId       String
  author         User     @relation(fields: [authorId], references: [id])

  @@map("events")
}

model AdminInvite {
  id          String    @id @default(cuid())
  email       String
  role        Role      @default(COORDINATOR)
  tokenHash   String    @unique
  expiresAt   DateTime
  acceptedAt  DateTime?
  revokedAt   DateTime?
  createdAt   DateTime  @default(now())
  createdById String
  createdBy   User      @relation("InviteCreator", fields: [createdById], references: [id])
  acceptedById String?
  acceptedBy   User?     @relation("InviteAcceptor", fields: [acceptedById], references: [id])

  @@index([email, expiresAt])
  @@index([createdById])
  @@map("admin_invites")
}

model PasskeyCredential {
  id                  String   @id @default(cuid())
  userId              String
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  credentialId        String   @unique
  credentialPublicKey String
  counter             Int      @default(0)
  transports          String?  @db.Text
  deviceType          String?
  backedUp            Boolean?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  lastUsedAt          DateTime?

  @@index([userId])
  @@map("passkey_credentials")
}

model AdminAuditLog {
  id        String   @id @default(cuid())
  actorId   String
  actor     User     @relation(fields: [actorId], references: [id], onDelete: Cascade)
  action    String
  targetId  String?
  metadata  String?  @db.Text
  ipAddress String?
  createdAt DateTime @default(now())

  @@index([actorId, createdAt])
  @@index([action, createdAt])
  @@map("admin_audit_logs")
}

model SummerCampRegistration {
  id              String   @id @default(cuid())
  studentName     String
  dob             String
  grade           String
  school          String
  allergies       String?
  tshirtSize      String
  parentName      String
  relationship    String
  email           String
  phone           String
  address         String
  city            String
  state           String
  zip             String
  emergencyName   String
  emergencyPhone  String
  sessionChoice   String
  heardFrom       String?
  specialRequests String?
  termsAccepted   Boolean  @default(false)
  medicalRelease  Boolean  @default(false)
  photoRelease    Boolean  @default(false)
  paymentStatus   String   @default("pending")
  paymentMethod   String?
  amount          Float?
  submittedAt     DateTime @default(now())

  @@map("summer_camp_registrations")
}

model ScholarshipApplication {
  id                String   @id @default(cuid())
  applicantName     String
  email             String
  phone             String
  dob               String
  address           String
  school            String
  grade             String
  gpa               String
  intendedMajor     String?
  extracurriculars  String?  @db.Text
  essayText         String   @db.Text
  resumeUrl         String?
  transcriptUrl     String?
  recommendationUrl String?
  status            String   @default("pending")
  reviewNotes       String?  @db.Text
  certified         Boolean  @default(false)
  eSignature        String
  submittedAt       DateTime @default(now())

  @@map("scholarship_applications")
}

model ContactSubmission {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  subject   String
  message   String   @db.Text
  createdAt DateTime @default(now())

  @@map("contact_submissions")
}

model Newsletter {
  id        String   @id @default(cuid())
  email     String   @unique
  createdAt DateTime @default(now())

  @@map("newsletter")
}
